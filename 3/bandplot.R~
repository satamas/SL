library(lattice)
bandplot <- function(formula, data, ...) {
  
  my.panel.bands <- function(x, y, high, low, col, fill, subscripts, ...) {
    order <- order(x)
    upper <- high[subscripts[order]]
    lower <- low[subscripts[order]]
    x <- x[order]
    panel.polygon(c(x, rev(x)), c(upper, rev(lower)), col=fill, border = FALSE, ...)
    panel.lines(x, upper, col = 'red');
    panel.lines(rev(x), rev(lower), col = 'red');
  }

  my.panel <- function(x, y,...) {
           panel.superpose(x, y, panel.groups = my.panel.bands, type='b', col='gray',...);
           panel.xyplot(x, y, type='p', cex=0.6, lty=1,...);           
           panel.loess(x, y, ...);
  }

  my.prepanel <- function(x,y,high,low,...) { 
    p<-prepanel.default.xyplot(x,y,...);
    p$ylim <- c(min(low), max(high));
    p
  }

  xyplot(formula, data, prepanel = my.prepanel, panel = my.panel, ...)
}
